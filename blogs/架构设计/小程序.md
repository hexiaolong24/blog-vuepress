# 小程序适老化设计

- 字体样式
- 间距、布局
- 热区放大

# 小程序性能

## 启动性能

- 代码包体积优化

  1.  合理分包

  - 独立分包：不需要加载主包： 支付页、广告也页、活动页
  - 分包预加载
  - 分包异步化：从页面粒度细分到组件、文件级别，即使在主包内使用，也可以剥离到分包中，使用时通过异步加载，可以解决主包大小过度膨胀的问题

  2.  避免非必要的全局自定义组件、插件
  3.  控制资源文件：尽量使用 cdn url
  4.  及时清理无用的代码和资源

- 代码注入优化

  1.  按需注入
  2.  用时注入
  3.  减少同步 api 使用

  - getSystemInfo/getSystemInfoSync
  - getStorageSync/setStorageSync

    4.  避免启动过程进行复杂运算

- 首屏渲染优化

  1.  按需注入/用时注入
  2.  初始渲染缓存：启用之后会跳过逻辑层，直接使用 data 中的静态数据渲染

  - 逻辑层初始化：载入必需的小程序代码、初始化页面 this 对象（也包括它涉及到的所有自定义组件的 this 对象）、将相关数据发送给视图层。
  - 视图层初始化：载入必需的小程序代码，然后等待逻辑层初始化完毕并接收逻辑层发送的数据，最后渲染页面

  3.  避免引用未使用的自定义组件
  4.  精简首屏数据，避免复杂组件渲染
  5.  提前首屏数据请求

  - 提前时机 Page.onLoad 或更早的时机发起网络请求，而不应等待 Page.onReady
  - 数据预拉取 ：冷启动时通过微信后台

    - 后台设置域名、设置 token

  - 周期性更新： 不打开小程序的情况下

    - 距离上次成功后每隔 12 小时获取一次
    - 用户 7 天内使用过的小程序
    - 对于弱网或者无网情况下

    6.  本地缓存数据请求
    7.  骨架屏

- 其他建议

1.  合理规划小程序发版计划
    - 重新获取小程序的基础信息
    - 进行小程序代码包的增量更新
    - 重新生成 JS 代码的 Code Cache
    - 重新生成初始渲染缓存

## 运行时性能

- 运行时性能出现问题，很容易出现页面滚动卡顿、响应延迟等问题，影响用户使用。如果内存占用过高，还会出现黑屏、闪退等问题。

  1.  合理使用 setData

  - 使用组件的性能 api setUpdatePerformanceListener 获取性能统计信息

  2.  渲染性能优化

  - 适当监听页面或组件的 scroll 事件
  - 高级的动画实现
  - css 渐变 css 动画
  - 关键帧动画
  - IntersectionObserver
  - 控制 WXML 节点数量和层级
  - 控制在 Page 构造时传入的自定义数据量

  3.  页面切换

  - 避免在 onHide/onUnload 执行耗时操作

  4.  资源加载优化

  - 图片资源大小
  - 避免滥用 image 组件的 widthFix/heightFix 模式

  5.  内存优化

  - 合理使用分包
  - 按需注入/用时注入
  - 具体内存分析
  - 处理内存告警，系统会自动回收，监听 wx.onMemoryWarning

# 问题

1.  为什么安卓和 iOS 的启动耗时差异那么大？

两个平台的设备性能、系统功能和启动流程实现存在一定差异：

iOS 设备的平均性能要好于安卓；
iOS 小程序和微信共用进程，而 Android 上小程序运行在独立进程，需要额外的进程创建和一些基础模块的初始化流程；
iOS 上需要使用系统提供的 WebView 和 JavaScript Core，初始化开销几乎可以忽略；
安卓 UI 和系统组件的创建的开销远高于 iOS。

2.  常见的内存泄漏问题

- 页面实例被未解绑的事件监听引用
- 页面实例被页面外变量或全局变量引用
- 页面实例被异步回调长时间引用
- 事件监听未及时解绑
- 未清理的定时器

3.  未来预见

- 项目隔离
- 性能优化工具沉淀（检测图片大小组件）
