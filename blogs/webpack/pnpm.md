---
title: pnpm
date: 2020-08-31
sidebar: "auto"
categories:
  - webpack
tags:
  - webpack
---

## npm

### npm v2

递归依赖，高度嵌套的依赖树

- 重复依赖
- 嵌套地狱
- 空间资源浪费
- 安装速度过慢
- 文件路径过长

### npm v3

npm 的扁平化依赖算法通过将所有依赖尽可能放在顶层 node_modules 目录下，减少了路径深度和重复依赖，从而避免“依赖地狱”。然而，由于需要解析大量依赖、解决版本冲突、处理网络请求和磁盘 I/O 操作，这个过程可能会耗时较长。

引入 lock 文件，锁定版本，保证稳定性

- 幽灵依赖

## yarn

yarn 出现时间为 2016 年，此时 npm 处于 v3 时期，其实当时 yarn 解决的问题基本就是 npm v5 解决的问题，

- yarn.lock 锁定版本依赖
- 实现并发网络请求，最大化网络资源利用率，
- 还有利用缓存机制，实现了离线模式

## pnpm

使用 npm 时，依赖每次被不同的项目使用，都会重复安装一次。 而在使用 pnpm 时，依赖会被存储在内容可寻址的存储中

- 不同版本的包只 update 不同的文件
- 所有文件都会存储在硬盘上的某一位置。 当软件包被被安装时，包里的文件会硬链接到这一位置，而不会占用额外的磁盘空间。 这允许你跨项目地共享同一版本的依赖。

原理

- node_modules 中每个包的每个文件都是来自内容可寻址存储的硬链接。
- 一旦所有包都硬链接到 node_modules，就会创建符号链接来构建嵌套的依赖关系图结构。

### pnpm 中的硬链接和符号链接

在 pnpm 中，**硬链接（hard link）和符号链接（symbolic link）**是用来节省磁盘空间和提高包管理性能的文件系统技术。它们通过减少重复的文件拷贝，让多个项目共享相同的依赖。

1. 硬链接（Hard Link）
   硬链接是指多个文件指向同一份数据，使用相同的文件索引节点（inode），因此文件之间共享内容。

在 pnpm 中的作用：pnpm 把所有下载的依赖包存储在全局的 store 中（通常在 ~/.pnpm-store），并使用硬链接将项目中的 node_modules 指向这些依赖。这意味着多个项目可以共享相同的依赖文件，避免了重复下载和占用空间。

特点：

- 硬链接文件实际上是指向同一个文件数据的不同入口，修改硬链接文件会直接影响其他文件。
- 删除硬链接文件并不会影响原文件的内容，只有当所有指向同一数据的硬链接都被删除后，文件才会从硬盘上移除。
  举例：假设有两个项目 project1 和 project2，都依赖于同一个包 lodash。在安装 lodash 后，pnpm 在两个项目的 node_modules 中创建了硬链接文件，指向相同的全局 store 中的 lodash。这样，在两个项目中修改 lodash 文件的内容时会影响到同一数据。

2. 符号链接（Symbolic Link）
   符号链接是一种指针文件，指向另一个文件或目录的路径。

在 pnpm 中的作用：pnpm 的 node_modules 目录是层级结构的，不会像 npm 和 yarn 那样将所有包平铺在根目录。pnpm 使用符号链接将依赖链接到顶层项目的 node_modules 文件夹下，从而形成虚拟的依赖树结构。

特点：

- 符号链接是路径指向关系，类似快捷方式，删除符号链接文件不会影响源文件。
- 符号链接可以指向目录或文件，也可以跨分区使用。
  举例：假设项目 project1 依赖 lodash 和 moment，而 moment 又依赖 lodash。在 project1 的 node_modules 中，pnpm 会创建一个符号链接，指向 moment 的 node_modules/lodash。这样，每个包都有独立的路径，同时保持空间利用率。
  硬链接和符号链接在 pnpm 中的配合
  硬链接：用来共享全局缓存的实际数据，避免重复拷贝。
  符号链接：用来组织项目的依赖结构，确保每个依赖的依赖关系能够独立管理且互不影响。

总结：

- 硬链接解决了磁盘空间问题，让不同项目共享相同依赖的实际数据。
- 符号链接则优化了依赖的目录结构，确保项目间的模块隔离性。

pnpm 通过硬链接和符号链接的结合，既能节省磁盘空间，又能实现模块独立性和安全性
