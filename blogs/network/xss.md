---
title: xss
date: 2019-09-12
sidebar: 'auto'
categories:
 - network
tags:
 - network
isShowComments: false
---

##  定义
Cross-Site Scripting（跨站脚本攻击）简称 XSS，是一种代码注入攻击。攻击者通过在目标网站上注入恶意脚本，使之在用户的浏览器上运行。利用这些恶意脚本，攻击者可获取用户的敏感信息如 Cookie、SessionID 等，进而危害数据安全。

##  可以做什么
  1.  窃取Cookie。
  2.  监听用户行为，比如输入账号密码后直接发送到黑客服务器。
  3.  修改 DOM 伪造登录表单。
  4.  在页面中生成浮窗广告。

##  哪些内容不可信
- 来自用户的 UGC 信息
- 来自第三方的链接
- URL 参数
- POST 参数
- Referer （可能来自不可信的来源）
- Cookie （可能来自其他子域注入）
##  分类

- 存储型
  1.  攻击者将恶意代码提交到目标网站的数据库中。
  2.  用户打开目标网站时，网站服务端将恶意代码从数据库取出，拼接在 HTML 中返回给浏览器。
  3.  用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
  4.  恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

  常见于带有用户保存数据的网站功能，如论坛发帖、商品评论、用户私信等
  

- 反射型
  1.  构造出特殊的 URL，其中包含恶意代码
  2.  用户打开带有恶意代码的 URL 时，网站服务端将恶意代码从 URL 中取出，拼接在 HTML 中返回给浏览器。
  3.  用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
  4.  恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

  反射型 XSS 跟存储型 XSS 的区别是：存储型 XSS 的恶意代码存在数据库里，反射型 XSS 的恶意代码存在 URL 里。
  由于需要用户主动打开恶意的 URL 才能生效，攻击者往往会结合多种手段诱导用户点击。
  常见于通过 URL 传递参数的功能，如网站搜索、跳转等。

- DOM型
  1.  攻击者构造出特殊的 URL，其中包含恶意代码。
  2.  用户打开带有恶意代码的 URL。
  3.  用户浏览器接收到响应后解析执行，前端 JavaScript 取出 URL 中的恶意代码并执行。
  4.  恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作

  DOM 型 XSS 跟前两种 XSS 的区别：DOM 型 XSS 攻击中，取出和执行恶意代码由浏览器端完成，属于前端 JavaScript 自身的安全漏洞，而其他两种 XSS 都属于服务端的安全漏洞。

##  预防
1.  攻击者提交恶意代码。
2.  浏览器执行恶意代码

##  措施
1.  过滤输入
2.  纯前端渲染
  1.  浏览器先加载一个静态 HTML，此 HTML 中不包含任何跟业务相关的数据。
  2.  然后浏览器执行 HTML 中的 JavaScript。
  3.  JavaScript 通过 Ajax 加载业务数据，调用 DOM API 更新到页面上。
3.  转义模板库
4.  在使用 .innerHTML、.outerHTML、document.write() 时要特别小心，不要把不可信的数据作为 HTML 插到页面上，而应尽量使用 .textContent、.setAttribute() 等。
5.  如果用 Vue/React 技术栈，并且不使用 v-html/dangerouslySetInnerHTML 功能，就在前端 render 阶段避免 innerHTML、outerHTML 的 XSS 隐患。
6.  严格的 CSP 
  使用csp，设置http请求头
  例如均来自站点的同一个源
  Content-Security-Policy: default-src 'self'
  - 禁止加载外域代码，防止复杂的攻击逻辑。
  - 禁止外域提交，网站被攻击后，用户的数据不会泄露到外域。
  - 禁止内联脚本执行（规则较严格，目前发现 GitHub 使用）。
  - 禁止未授权的脚本执行（新特性，Google Map 移动版在使用）。
  - 合理使用上报可以及时发现 XSS，利于尽快修复问题。
7.  HTTP-only Cookie: 禁止 JavaScript 读取某些敏感 Cookie，攻击者完成 XSS 注入后也无法窃取此 Cookie。
8.  验证码，防止模拟用户提交




