---
title: 性能优化指标
date: 2021-07-02
sidebar: "auto"
categories:
  - 性能优化
tags:
  - 性能优化
---

## Lighthouse
分别是页面性能（performance）、Progressive（渐进式 Web 应用）、Accessibility（可访问性）、Best Practices（最佳实践）、SEO 五项指标的跑分

- performance

1.  OPPORTUNITIES

- 有 FCP LCP 等指标数据
- http2
- 压缩文件
- 图片格式 像 WebP 和 AVIF 这样的图像格式通常比 PNG 或 JPEG 提供更好的压缩，这意味着更快的下载和更少的数据消耗
- 延时加载无用 js css

2.  DIAGNOSTICS

- img 元素明确宽高
- 缓存资源
- 减少 js 执行时间

* Accessibility（可访问性）
* Best Practices（最佳实践）
* SEO
* PWA

# 前端质量评测体系

- 前端应用质量评测体系不仅仅是一个技术问题：它影响着从可访问性到可用性到搜索引擎优化，以及工作流程的每一个方面。当把它放入工作流程时，工程师必须考虑到它们的性能影响和用户体验。应用质量需要不断地测量、监控和改进，而且网络日益增长的复杂性也带来了新的挑战，使得跟踪衡量标准变得越发困难，因为前端质量数据将根据用户的设备、浏览器、协议和网络延迟而发生显著变化，例如：CDN（内容分发网络）、 ISP（Internet Service Provider）、缓存、代理、防火墙、负载均衡和服务器都在性能方面扮演着重要角色等。

- 前端质量评测体系的评估维度包括解析耗时、连接耗时（TCP、SSL）、TTFB（Time To First Byte）、FP（First Paint）、FCP（First Contentful Paint）、LCP（Largest Contentful Paint）、FID（First Input Delay）、TTI（Time to Interactive）、TBT（Total Blocking Time）、CLS（Cumulative Layout Shift）、慢接口率、接口故障率、脚本错误率、代码覆盖率等等。通过这些维度对页面进行评估并制定优化方案，最终实现优秀的产品品质，提升用户体验和产品转化。

## 指标统计说明

- 我们的主要目标是为用户提供高质量的使用体验。有鉴于此，我们的目标是确保 web 页面的性能指标达到「良好」的阈值。但对于某些度量标准，小样本异常量（以及由此导致的无法获得有用数据的精确性）的问题会比其他度量标准更常发生，而且样本量也会因收集数量而异。例如，计算一个有意义的平均值所需的数据比计算一个同样有意义的 95% 所需的数据要少。

- 这些目标彼此之间有些不一致。为了达到优秀的目标，百分比越高通常是越好的选择。然而，随着百分位数的增加，结果值受异常值影响的可能性也增加了。如果一个网站的一些访问碰巧是在较差的网络环境上，就会导致 LCP 样本过大。我们不希望我们的网站分类被这些离群样本所决定。例如，如果我们使用 95% 这样的高百分位数来评估一个访问量达到 100 次的站点的性能，那么只需要 5 个 95% 的异常值样本就会受到异常值的影响。

- 如前所述，为了对我们应用的整体性能进行分析，我们使用该应用所有访问量的 75% 分位的值，即 P75。P75 表明，25% 的事务大于阈值。例如，如果将 P75 阈值 设置为 100 毫秒，则 25% 的事务超过该阈值，所需时间超过 100 毫秒。选择 P75 基于两个标准：

  - 首先，百分位数应该确保大多数访问一个页面或网站达到了优秀水平的性能。
  - 其次，选择的百分位数值不应该过度受到异常值的影响。

当然，P75 只是我们的默认统计标准，我们在访问量较大的应用上可以采取更高的标准，比如 P90、P95、P99 等。

- 度量标准通常以下列两种方式之一来测量：

  - 在实验室中：使用工具在一致的受控环境中模拟页面加载
  - 在用户真实访问中：在真正的用户实际加载和交互的页面

这两种选择都不一定比另一种更好或更糟，而且实际上，我们通常希望同时使用这两种选择来确保良好的性能。

## 核心指标

核心指标为衡量应用质量的重要指标，主要从以下方面来衡量用户对性能的感知：

- 可感知到的加载速度， 页面加载并将所有可视元素呈现到屏幕的速度
- 页面的响应，页面对用户交互的响应速度
- 视觉稳定性，页面上的元素是否会以用户意想不到的方式发生变化，干扰了他们的交互过程

P75下

指标|优秀|需要提升|衡量目标
---|:--:|---:|---:
LCP|<= 2.5s|<= 4s|页面加载
FID|<= 100ms|<= 300ms|交互响应
CLS|<= 0.1|<= 0.25|视觉稳定性
Apdex|>= 0.75|>= 0.3|用户满意度

1.  LCP
测量最大内容出现在视口中的时间，统计的元素主要有：

```
<img> 元素
使用了海报的 <video> 元素
<svg> 内部的 <image> 元素
使用 css url() 加载背景图像的元素
包含文本节点或包含内联文本子元素的块级元素
```
- 统计方式

在第一帧展示时使用 PerformanceEntry 标识最大的元素，当后续帧中有更大的元素显示时，再次调用 PerformanceEntry 标记最大元素，一直到停止渲染或用户与页面开始交互（通过点击或按键），浏览器将立即停止报告新 entries。如果一个当前最大的内容元素从视窗中消失（即使从 DOM 中移除），它将仍然是最大的内容元素，除非渲染一个更大的元素。

⚠️ 注意：

- 资源若未设置 Timing-Allow-Origin 响应头，会导致上报时间不准确；
- 在某些情况下，页面上最重要的元素与最大的元素不同；
- 被调整大小的图片以较小值为准；
- 对于文本元素，只考虑其文本节点的大小（包含所有文本节点的最小矩形）；
- 所有元素忽略 css 设置的 margin、padding、border 等。

2.  FID
首次输入延迟，测量用户尝试与视口交互时的响应时间。操作可能包括单击按钮、链接或其他自定义 Javascript 控制器。输入延迟发生是因为浏览器的主线程正忙于做其他事情（解析 JS 等），导致无法响应用户，所以低 FID 有助于确保页面可用。

3.  CLS
衡量渲染过程中每个意外移动元素的各个布局偏移分数的总和，它代表了破坏性和视觉不稳定转变的程度，有助于量化用户感受到意外布局偏移的频率。

- 计算方式

layout shift score = impact fraction * distance fraction
impact fraction：测量两帧之间不稳定元素影响的视窗区域。
distance fraction：所有不稳定元素在视窗（水平或垂直）中移动的最大距离，除以视窗的最大尺寸（MAX(width, height)）。

3.  Apdex
性能指数 Apdex（Application Performance Index） 是一个国际通用标准，指数与用户体验紧密关联，较真实反应了网站性能状况，是用户对应用性能满意度的量化值。

Apdex 提供了一个统一的测量和报告用户体验的方法，把用户最终的体验和应用性能作为一个完整的指标进行统一度量，基于真实用户体验，Apdex 定义了 3 个用户满意区间：满意、可容忍、失望。

- 计算方式
对整个页面和所有依赖资源的加载时间进行采集（略等于 onload 事件节点），经过计算可以得出 Apdex 指数。

⚠️ 注：在 Sentry 中，通过监听浏览器路由的 popstate 来设置 「navigation」 事务，或在 Vue / React 等框架中通过 router 设置 「pageload」 事务，此事务只取其一来计算 Apdex 指数。

以下是 Apdex 的组成部分及其模式:

  - T：目标响应时间的阈值，web 端页面默认为 1500ms，离线包为 500ms
  - Satisfactory(令人满意)：当用户的页面加载时间小于或等于 t 时，他们会满意地使用该应用程序
  - Tolerable(还可忍受)：当用户的页面加载时间介于 t 和 4t 之间时，他们认为应用程序可以容忍使用
  - Frustrated(失望)：当用户的页面加载时间大于 4t 时，他们会对应用程序感到失望
  - Apdex 的计算公式为 ( 满意数量 + ( 可容忍数量 / 2 ) ) / 总样本数

这样，用户访问页面的响应时间被量化为一个 0 - 1 之间的数值，数值越高，满意度越高:

0 - 没有满意用户
1 - 所有用户都满意
0.75 是一个默认标准，表示网站性能良好。同样，可以定为更高于这个标准值的数，例如 0.85。

##  辅助指标
辅助指标为非核心指标以外的性能指标，可以用来辅助判断核心指标异常的具体情况。

P75
指标|优秀|需要提升|衡量目标
---|:--:|---:|---:
TTFB|<= 100ms|<= 200ms|网络状况
FP|<= 1s|<= 3s|绘制前阻塞情况
FCP|<= 1s|<= 3s|内容绘制
TTI|<= 3.8s|<= 7.3s|可交互时间
TBT|<= 200ms|<= 600ms|长任务阻塞情况

TTFB、FP、FCP 通常表示为加载体验指标，可用来诊断 LCP 问题。

TTI、TBT 用来诊断可能影响 FID 的潜在问题，但这两个指标为实验室指标（通过 Lighthouse 测量）非实地测量，不能反映用户的真实情况，并且 TTI 只是一种算法，并不严谨，可通过一些方式绕过。

除以上几种指标以外，Sentry 中还有 Failure Rate（故障率）、User Misery（用户痛苦）等指标。

1.  TTFB
浏览器建立连接后发出请求到接收到服务器第一个字节所需的时间，TTFB 太长说明服务器相应慢或者网络较差。

2.  FP
测量第一个像素出现在视口中所花费的时间。

3.  FCP
测量第一个内容在视口中呈现的时间。可以是来自文档对象模型 (DOM) 的任何形式，例如图像、SVG 或文本块。 FCP 经常与 First Paint (FP) 重叠。 FCP 帮助开发人员了解用户在页面上看到任何内容需要多长时间。

4.  TTI
衡量从页面开始加载到其主要子资源加载的时间，并且能够可靠地快速响应用户输入，反映了一个页面需要多长时间才能完全交互。
